// --- Supabase Config ---
// Replace these with your actual Supabase project values
const SUPABASE_URL = "https://qoachpijtlbsxeyabdpl.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_-vYudRVg3UUVYGEHV55_Pw_bJEfiW1c";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

let allAssignees = [];

// --- Auth ---

const loginSection = document.getElementById("login-section");
const appSection = document.getElementById("app-section");
const loginForm = document.getElementById("login-form");
const loginError = document.getElementById("login-error");

sb.auth.onAuthStateChange((event, session) => {
  if (session) {
    document.body.classList.remove("logged-out");
    document.body.classList.add("logged-in");
    loadBoard();
  } else {
    document.body.classList.remove("logged-in");
    document.body.classList.add("logged-out");
  }
});

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  loginError.classList.add("hidden");

  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;

  const { error } = await sb.auth.signInWithPassword({ email, password });

  if (error) {
    loginError.textContent = error.message;
    loginError.classList.remove("hidden");
  }
});

document.getElementById("btn-logout").addEventListener("click", async () => {
  await sb.auth.signOut();
});

// --- Fetch & Render ---

async function loadBoard() {
  const [tasksRes, assigneesRes] = await Promise.all([
    sb.from("tasks").select("*"),
    sb.from("assignees").select("name"),
  ]);

  if (tasksRes.error) {
    console.error("Error loading tasks:", tasksRes.error);
    return;
  }
  if (assigneesRes.error) {
    console.error("Error loading assignees:", assigneesRes.error);
    return;
  }

  allAssignees = assigneesRes.data.map((a) => a.name);
  renderTasks(tasksRes.data || []);
}

function renderTasks(tasks) {
  document.querySelectorAll(".card-list").forEach((list) => {
    list.innerHTML = "";
  });

  tasks.forEach((task) => {
    const list = document.querySelector(
      `.card-list[data-status="${task.status}"]`
    );
    if (!list) return;
    list.appendChild(createCard(task));
  });
}

function createCard(task) {
  const card = document.createElement("div");
  card.className = "card";
  card.draggable = true;
  card.dataset.id = task.id;

  const dueDate = task.due_date || "";
  const isOverdue =
    dueDate && new Date(dueDate) < new Date().setHours(0, 0, 0, 0) &&
    task.status !== "done";

  if (isOverdue) card.classList.add("overdue");

  const nextMap = {
    backlog: { status: "todo", icon: "&#x279C;", cls: "advance-blue" },
    todo: { status: "inprogress", icon: "&#x23F3;", cls: "advance-yellow" },
    inprogress: { status: "done", icon: "&#x2714;", cls: "advance-green" },
  };

  const badges = (task.assignees || [])
    .map((a) => `<span class="badge">${esc(a)}</span>`)
    .join("");

  let dueDateHtml = "";
  if (dueDate) {
    const cls = isOverdue ? "due-date overdue" : "due-date";
    dueDateHtml = `<span class="${cls}">${dueDate}</span>`;
  }

  const next = nextMap[task.status];
  const advanceHtml = next
    ? `<button class="btn-advance ${next.cls}" data-next="${next.status}">${next.icon}</button>`
    : "";

  card.innerHTML = `
    ${advanceHtml}
    <div class="card-title">${esc(task.title)}</div>
    <div class="card-meta">${badges}${dueDateHtml}</div>
  `;

  // Advance button click
  const advanceBtn = card.querySelector(".btn-advance");
  if (advanceBtn) {
    advanceBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const { error } = await sb
        .from("tasks")
        .update({ status: advanceBtn.dataset.next })
        .eq("id", task.id);
      if (error) console.error("Error advancing task:", error);
      loadBoard();
    });
  }

  // Drag events
  card.addEventListener("dragstart", (e) => {
    card.classList.add("dragging");
    e.dataTransfer.setData("text/plain", task.id);
    e.dataTransfer.effectAllowed = "move";
  });

  card.addEventListener("dragend", () => {
    card.classList.remove("dragging");
  });

  // Click to edit
  card.addEventListener("click", () => openModal(task));

  return card;
}

// --- Drag & Drop ---

document.querySelectorAll(".card-list").forEach((list) => {
  list.addEventListener("dragover", (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
    list.classList.add("drag-over");
  });

  list.addEventListener("dragleave", () => {
    list.classList.remove("drag-over");
  });

  list.addEventListener("drop", async (e) => {
    e.preventDefault();
    list.classList.remove("drag-over");
    const taskId = e.dataTransfer.getData("text/plain");
    const newStatus = list.dataset.status;

    const { error } = await sb
      .from("tasks")
      .update({ status: newStatus })
      .eq("id", taskId);

    if (error) console.error("Error updating task status:", error);
    loadBoard();
  });
});

// --- Modal ---

const overlay = document.getElementById("modal-overlay");
const form = document.getElementById("task-form");
const formId = document.getElementById("form-id");
const formTitle = document.getElementById("form-title");
const formStatus = document.getElementById("form-status");
const formDue = document.getElementById("form-due");
const formAssignees = document.getElementById("form-assignees");
const modalTitle = document.getElementById("modal-title");
const btnDelete = document.getElementById("btn-delete");

document.getElementById("btn-add").addEventListener("click", () => openModal());
document.getElementById("btn-cancel").addEventListener("click", closeModal);
overlay.addEventListener("click", (e) => {
  if (e.target === overlay) closeModal();
});

function openModal(task = null) {
  form.reset();
  formId.value = "";

  // Build assignee checkboxes
  formAssignees.innerHTML = allAssignees
    .map(
      (a) => `
    <label>
      <input type="checkbox" value="${esc(a)}" ${
        task && task.assignees.includes(a) ? "checked" : ""
      }>
      ${esc(a)}
    </label>`
    )
    .join("");

  if (task) {
    modalTitle.textContent = "Modifica Task";
    formId.value = task.id;
    formTitle.value = task.title;
    formStatus.value = task.status;
    formDue.value = task.due_date || "";
    btnDelete.classList.remove("hidden");
  } else {
    modalTitle.textContent = "Nuova Task";
    btnDelete.classList.add("hidden");
  }

  overlay.classList.remove("hidden");
  formTitle.focus();
}

function closeModal() {
  overlay.classList.add("hidden");
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const selectedAssignees = [
    ...formAssignees.querySelectorAll("input:checked"),
  ].map((cb) => cb.value);

  const payload = {
    title: formTitle.value.trim(),
    status: formStatus.value,
    assignees: selectedAssignees,
    due_date: formDue.value,
  };

  if (formId.value) {
    const { error } = await sb
      .from("tasks")
      .update(payload)
      .eq("id", formId.value);
    if (error) console.error("Error updating task:", error);
  } else {
    const { error } = await sb.from("tasks").insert(payload);
    if (error) console.error("Error creating task:", error);
  }

  closeModal();
  loadBoard();
});

btnDelete.addEventListener("click", async () => {
  if (!formId.value) return;
  if (!confirm("Eliminare questa task?")) return;

  const { error } = await sb
    .from("tasks")
    .delete()
    .eq("id", formId.value);

  if (error) console.error("Error deleting task:", error);
  closeModal();
  loadBoard();
});

// --- Helpers ---

function esc(str) {
  const d = document.createElement("div");
  d.textContent = str;
  return d.innerHTML;
}
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanban Todo</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="logged-out">

  <!-- Login -->
  <div id="login-section" class="login-section">
    <div class="login-card">
      <h1>Kanban Board</h1>
      <form id="login-form">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required placeholder="email@esempio.com">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required placeholder="Password">
        <button type="submit" class="btn-primary">Accedi</button>
        <p id="login-error" class="login-error hidden"></p>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="app-section" class="app-section">
    <header>
      <h1>Kanban Board</h1>
      <div class="header-actions">
        <button id="btn-add" title="Nuova task">+</button>
        <button id="btn-logout" class="btn-logout" title="Logout">Logout</button>
      </div>
    </header>

    <main class="board">
      <div class="column" data-status="backlog">
        <h2>Backlog</h2>
        <div class="card-list" data-status="backlog"></div>
      </div>
      <div class="column" data-status="todo">
        <h2>Todo</h2>
        <div class="card-list" data-status="todo"></div>
      </div>
      <div class="column" data-status="inprogress">
        <h2>In Progress</h2>
        <div class="card-list" data-status="inprogress"></div>
      </div>
      <div class="column" data-status="done">
        <h2>Done</h2>
        <div class="card-list" data-status="done"></div>
      </div>
    </main>

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay hidden">
      <div class="modal">
        <h3 id="modal-title">Nuova Task</h3>
        <form id="task-form">
          <input type="hidden" id="form-id">
          <label for="form-title">Titolo</label>
          <input type="text" id="form-title" required>

          <label for="form-status">Stato</label>
          <select id="form-status">
            <option value="backlog">Backlog</option>
            <option value="todo">Todo</option>
            <option value="inprogress">In Progress</option>
            <option value="done">Done</option>
          </select>

          <label>Assegnatari</label>
          <div id="form-assignees" class="checkbox-group"></div>

          <label for="form-due">Scadenza</label>
          <input type="date" id="form-due">

          <div class="modal-actions">
            <button type="submit" class="btn-primary">Salva</button>
            <button type="button" id="btn-cancel" class="btn-secondary">Annulla</button>
            <button type="button" id="btn-delete" class="btn-danger hidden">Elimina</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f0f2f5;
  color: #1a1a1a;
  min-height: 100vh;
}

/* Auth visibility toggle */
body.logged-out .app-section {
  display: none;
}

body.logged-in .login-section {
  display: none;
}

/* Login */
.login-section {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}

.login-card {
  background: #fff;
  border-radius: 12px;
  padding: 32px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
}

.login-card h1 {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 24px;
  text-align: center;
}

.login-card label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 4px;
  margin-top: 12px;
}

.login-card input[type="email"],
.login-card input[type="password"] {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
}

.login-card input:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
}

.login-card .btn-primary {
  width: 100%;
  margin-top: 20px;
}

.login-error {
  color: #ef4444;
  font-size: 0.8rem;
  margin-top: 12px;
  text-align: center;
}

/* Header */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: #fff;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

header h1 {
  font-size: 1.4rem;
  font-weight: 700;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

#btn-add {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 50%;
  background: #4f46e5;
  color: #fff;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.15s;
}

#btn-add:hover {
  background: #4338ca;
}

.btn-logout {
  padding: 8px 16px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: #fff;
  color: #374151;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}

.btn-logout:hover {
  background: #f3f4f6;
}

/* Board */
.board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Columns */
.column {
  background: #e5e7eb;
  border-radius: 12px;
  padding: 12px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.column h2 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 8px 4px;
  margin-bottom: 8px;
  border-bottom: 3px solid transparent;
}

.column[data-status="backlog"] h2 { border-color: #6b7280; color: #6b7280; }
.column[data-status="todo"] h2 { border-color: #3b82f6; color: #3b82f6; }
.column[data-status="inprogress"] h2 { border-color: #f59e0b; color: #f59e0b; }
.column[data-status="done"] h2 { border-color: #10b981; color: #10b981; }

.card-list {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 40px;
}

.card-list.drag-over {
  background: rgba(79, 70, 229, 0.08);
  border-radius: 8px;
}

/* Cards */
.card {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  cursor: grab;
  transition: box-shadow 0.15s, opacity 0.15s;
  border-left: 3px solid transparent;
}

.card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.card.dragging {
  opacity: 0.4;
}

.card.overdue {
  border-left-color: #ef4444;
  background: #fef2f2;
}

/* Advance dot */
.card {
  position: relative;
}

.btn-advance {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  min-width: 28px;
  min-height: 28px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  line-height: 1;
  padding: 0;
  transition: transform 0.15s, opacity 0.15s;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.btn-advance:hover {
  transform: scale(1.15);
}

.btn-advance:active {
  transform: scale(0.95);
}

.advance-blue { background: #3b82f6; color: #fff; }
.advance-yellow { background: #f59e0b; color: #fff; }
.advance-green { background: #10b981; color: #fff; }

.card-title {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 8px;
  padding-right: 36px;
}

.card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 9999px;
  font-size: 0.7rem;
  font-weight: 600;
  background: #e0e7ff;
  color: #4338ca;
}

.due-date {
  font-size: 0.75rem;
  color: #6b7280;
  margin-left: auto;
}

.due-date.overdue {
  color: #ef4444;
  font-weight: 600;
}

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.modal-overlay.hidden {
  display: none;
}

.modal {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
}

.modal h3 {
  margin-bottom: 16px;
  font-size: 1.1rem;
}

.modal label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 4px;
  margin-top: 12px;
}

.modal input[type="text"],
.modal input[type="date"],
.modal select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
}

.modal input:focus,
.modal select:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
}

.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 4px;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.85rem;
  font-weight: 500;
  color: #1a1a1a;
  margin: 0;
  cursor: pointer;
}

.modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 20px;
}

.btn-primary,
.btn-secondary,
.btn-danger {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
}

.btn-primary {
  background: #4f46e5;
  color: #fff;
}
.btn-primary:hover { background: #4338ca; }

.btn-secondary {
  background: #e5e7eb;
  color: #374151;
}
.btn-secondary:hover { background: #d1d5db; }

.btn-danger {
  background: #ef4444;
  color: #fff;
  margin-left: auto;
}
.btn-danger:hover { background: #dc2626; }

.hidden {
  display: none !important;
}

/* Responsive */
@media (max-width: 900px) {
  .board {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 500px) {
  .board {
    grid-template-columns: 1fr;
  }
}
